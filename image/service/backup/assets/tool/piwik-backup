#!/bin/bash -e

# Usage: /sbin/mail-backup
backupPath="/data/backup"

source /container/run/environment.sh

# delete backups that are over $PIWIK_BACKUP_TTL days
find $backupPath -type f -mtime +$PIWIK_BACKUP_TTL -exec rm {} \;

# Date format for the dump file name
dateFileFormat="+%Y%m%dT%H%M%S"
backupFilePath="$backupPath/$(date "$dateFileFormat")-piwik.tar.gz"

# save config and plugins except default ones
tar -czf $backupFilePath -C / var/www/piwik/config/config.ini.php var/www/piwik/plugins --exclude var/www/piwik/plugins/API --exclude var/www/piwik/plugins/Actions --exclude var/www/piwik/plugins/Annotations --exclude var/www/piwik/plugins/BulkTracking --exclude var/www/piwik/plugins/Contents --exclude var/www/piwik/plugins/CoreAdminHome --exclude var/www/piwik/plugins/CoreConsole --exclude var/www/piwik/plugins/CoreHome --exclude var/www/piwik/plugins/CorePluginsAdmin --exclude var/www/piwik/plugins/CoreUpdater --exclude var/www/piwik/plugins/CoreVisualizations --exclude var/www/piwik/plugins/CustomVariables --exclude var/www/piwik/plugins/DBStats --exclude var/www/piwik/plugins/Dashboard --exclude var/www/piwik/plugins/DevicePlugins --exclude var/www/piwik/plugins/DevicesDetection --exclude var/www/piwik/plugins/Diagnostics --exclude var/www/piwik/plugins/Ecommerce --exclude var/www/piwik/plugins/Events --exclude var/www/piwik/plugins/ExampleAPI --exclude var/www/piwik/plugins/ExampleCommand --exclude var/www/piwik/plugins/ExamplePlugin --exclude var/www/piwik/plugins/ExampleReport --exclude var/www/piwik/plugins/ExampleRssWidget --exclude var/www/piwik/plugins/ExampleSettingsPlugin --exclude var/www/piwik/plugins/ExampleTheme --exclude var/www/piwik/plugins/ExampleTracker --exclude var/www/piwik/plugins/ExampleUI --exclude var/www/piwik/plugins/ExampleVisualization --exclude var/www/piwik/plugins/Feedback --exclude var/www/piwik/plugins/Goals --exclude var/www/piwik/plugins/Heartbeat --exclude var/www/piwik/plugins/ImageGraph --exclude var/www/piwik/plugins/Insights --exclude var/www/piwik/plugins/Installation --exclude var/www/piwik/plugins/Intl --exclude var/www/piwik/plugins/LanguagesManager --exclude var/www/piwik/plugins/Live --exclude var/www/piwik/plugins/Login --exclude var/www/piwik/plugins/MobileAppMeasurable --exclude var/www/piwik/plugins/MobileMessaging --exclude var/www/piwik/plugins/Monolog --exclude var/www/piwik/plugins/Morpheus --exclude var/www/piwik/plugins/MultiSites --exclude var/www/piwik/plugins/Overlay --exclude var/www/piwik/plugins/PrivacyManager --exclude var/www/piwik/plugins/ProfessionalServices --exclude var/www/piwik/plugins/Provider --exclude var/www/piwik/plugins/Proxy --exclude var/www/piwik/plugins/Referrers --exclude var/www/piwik/plugins/Resolution --exclude var/www/piwik/plugins/SEO --exclude var/www/piwik/plugins/ScheduledReports --exclude var/www/piwik/plugins/SegmentEditor --exclude var/www/piwik/plugins/SitesManager --exclude var/www/piwik/plugins/Transitions --exclude var/www/piwik/plugins/UserCountry --exclude var/www/piwik/plugins/UserCountryMap --exclude var/www/piwik/plugins/UserId --exclude var/www/piwik/plugins/UserLanguage --exclude var/www/piwik/plugins/UsersManager --exclude var/www/piwik/plugins/VisitFrequency --exclude var/www/piwik/plugins/VisitTime --exclude var/www/piwik/plugins/VisitorInterest --exclude var/www/piwik/plugins/VisitsSummary --exclude var/www/piwik/plugins/WebsiteMeasurable --exclude var/www/piwik/plugins/Widgetize

exit 0
